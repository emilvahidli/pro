# Reverse proxy for local proep.az ecosystem
# Start with: docker compose --profile with-nginx up -d
# Then: admin.proep.az and proep.az (add to /etc/hosts: 127.0.0.1 admin.proep.az proep.az)

events {
    worker_connections 1024;
}

http {
    # Resolve Docker service names
    resolver 127.0.0.11 valid=10s ipv6=off;

    # admin.proep.az → admin-dashboard (port 80 inside container)
    server {
        listen 80;
        server_name admin.proep.az;
        location / {
            proxy_pass http://admin-dashboard:80;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # proep.az → proep-frontend; /api/messages → proep-backend (contact form)
    server {
        listen 80;
        server_name proep.az www.proep.az;
        location /api/messages {
            proxy_pass http://proep-backend:4000;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        location / {
            proxy_pass http://proep-frontend:80;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # Default server: /api/messages → proep-backend, /api → scraping-service, else proep.az
    server {
        listen 80 default_server;
        server_name _;

        location /api/messages {
            proxy_pass http://proep-backend:4000;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        location /api/ {
            proxy_pass http://scraping-service:4000/api/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location / {
            proxy_pass http://proep-frontend:80;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
